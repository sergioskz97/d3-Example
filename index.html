<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <style>
    .bar {
      fill: steelblue;
    }

    .bubbles {
      stroke-width: 1px;
      stroke: black;
      opacity: .8
    }

    .bubbles:hover {
      stroke: black;
    }

    .link {
      fill: none;
      stroke: #000;
      stroke-opacity: .2;
    }

    .link:hover {
      stroke-opacity: .5;
    }

    .node rect {
      cursor: move;
      fill-opacity: .9;
      shape-rendering: crispEdges;
    }

    .node text {
      pointer-events: none;
      text-shadow: 0 1px 0 #fff;
    }

    .link {
      fill: none;
      stroke: #000;
      stroke-opacity: .2;
    }

    .link:hover {
      stroke-opacity: .5;
    }
  </style>

  <meta charset="utf-8">
  <title>D3.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"
    integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js"
    integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG"
    crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/sankey.js"></script>
  <script src="sankey.js"></script>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light" aria-label="Tenth navbar example">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample08"
        aria-controls="navbarsExample08" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-md-center" id="navbarsExample08">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#"> <b>Introducción a D3</b> </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <h1>Gráfico de barras</h1>
  <div id="barchart" style="align-content: center;"></div>

  <script>
    var margin = { top: 10, right: 20, bottom: 30, left: 50 },
      width = 900 - margin.left - margin.right,
      height = 600 - margin.top - margin.bottom;

    var svg = d3.select("#barchart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

    ///////////////////////
    // Gráfico de barras //
    ///////////////////////
    d3.csv("trafico_2020.csv", function (data) {

      // Agrupamos los datos
      dat = d3.nest().key(d => d.Puerto)
        .sortKeys(d3.ascending)
        .rollup(function (ids) { return ids.length; })
        .entries(data);

      //console.log(dat)

      var x = d3.scaleBand()
        .range([0, width])
        .domain(data.map(function (d) { return d.Puerto; }))
        .padding(0.2);
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end");

      var y = d3.scaleLinear()
        .domain([0, 75000])
        .range([height, 0]);
      svg.append("g")
        .call(d3.axisLeft(y));

      svg.selectAll("mybar")
        .data(dat)
        .enter()
        .append("rect")
        .attr("x", function (d) { return x(d.key); })
        .attr("y", function (d) { return y(d.value); })
        .attr("width", x.bandwidth())
        .attr("height", function (d) { return height - y(d.value); })
        .attr("fill", "#69b3a2")

    })
  </script>

  <br>
  <br>
  <h1>Gráfico de burbujas</h1>
  <div id="bubblechart"></div>

  <script>

    var svg2 = d3.select("#bubblechart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

    /////////////////////////
    // Gráfico de burbujas //
    /////////////////////////

    // Cargamos el dataset
    d3.csv("trafico_2020.csv", function (data) {
      //console.log(data[0]);

      // Subdividimos en los grupos
      dat = d3.nest()
        .key(d => d.Mes)
        .key(d => d.Puerto)
        .rollup(function (v) {
          return {
            ports: v.length,
            tons: d3.sum(v, function (d) { return d.Toneladas; })
          }
        })
        .entries(data);

      var dataset = [];

      //console.log(dat);

      // Unificamos los datos
      for (var i = 0; i < dat.length; i++) {
        for (var j = 0; j < dat[i].values.length; j++) {
          var aux = {};
          aux.Mes = dat[i].key;
          aux.Puerto = dat[i].values[j].key;
          aux.Toneladas = dat[i].values[j].value.tons;
          aux.Ocurrencias = dat[i].values[j].value.ports;

          dataset.push(aux);
        }
      }

      //console.log(dataset);

      var x = d3.scaleBand()
        .range([0, width])
        .domain(dataset.map(function (d) { return d.Mes; }))
        .padding(0.2);
      svg2.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end");


      var y = d3.scaleLinear()
        .domain([0, 155000])
        .range([height, 0]);
      svg2.append("g")
        .call(d3.axisLeft(y));

      var z = d3.scaleLinear()
        .domain([0, 3600])
        .range([4, 40]);

      // Seleccionamos los colores
      var myColor = d3.scaleOrdinal()
        .domain(["LA ESTACA (EL HIERRO)", "LOS CRISTIANOS", "S/C DE LA PALMA", "S/C DE TENERIFE", "S/S DE LA GOMERA"])
        .range(d3.schemeSet2);

      svg2.append('g')
        .selectAll("dot")
        .data(dataset)
        .enter()
        .append("circle")
        .attr("cx", function (d) { return x(d.Mes); })
        .attr("cy", function (d) { return y(parseInt(d.Toneladas)); })
        .attr("r", function (d) { return z(d.Ocurrencias / 5); })
        .style("fill", function (d) { return myColor(d.Puerto); })
        .style("opacity", "0.7")
        .attr("stroke", "white")
        .style("stroke-width", "2px")
    });
  </script>

  <h1>Gráfico de Sankey</h1>
  <div id="sankeychart"></div>

  <script>
    var units = "claims";

    var formatNumber = d3.format(",.0f"),
      formatMillions = d3.format(",.4s"),
      formatFactor = d3.format(",.2f"),
      format = function (d) { return formatNumber(d) + " " + units; },
      color = d3.scaleOrdinal(d3.schemeCategory20);

    var svg3 = d3.select("#sankeychart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

    var sankey = d3.sankey()
      .nodeWidth(36)
      .nodePadding(40)
      .size([width, height]);

    var path = sankey.link();

    d3.csv("trafico_2020.csv", function (error, data) {

      console.log(data[0]);

      graph = { "nodes": [], "links": [] };

      data.forEach(e => {
        e['Puerto_Origen'] = e['Puerto Origen'];
        e['Puerto_Destino'] = e['Puerto Destino'];

        delete e['Puerto Origen'];
        delete e['Puerto Destino'];
      });

      data.forEach(function (d) {
        graph.nodes.push({
          "name": d.source, "status": d.Puerto_Origen,
          "source_value": +d.source_value
        });
        graph.nodes.push({
          "name": d.target, "status": d.source.split(":")[0],
          "target_value": +d.target_value
        });
        graph.links.push({
          "source": d.source,
          "target": d.target,
          "value": +d.count,
          "source_value": +d.source_value,
          "target_value": +d.target_value
        });
      });

      console.log(graph);

      /*graph.nodes = d3.nest()
        .key(function (d) { return d.name; })
        .rollup(function (d, i) {
          console.log("rollup", i, d);
          return {
            "name": d[0].name,
            "status": d[0].status,
            "source_value": d3.sum(d, function (dd) { return dd.source_value; }),
            "target_value": d3.sum(d, function (dd) { return dd.target_value; })
          }
        })
        .entries(graph.nodes);

      graph.nodekeys = graph.nodes.map(function (d) { return d.key });

      console.log("nodes", graph.nodes);
      //console.log("links", graph.links);

      // loop through each link replacing the text with its index from node
      graph.links.forEach(function (d, i) {
        graph.links[i].source = graph.nodekeys.indexOf(graph.links[i].source);
        graph.links[i].target = graph.nodekeys.indexOf(graph.links[i].target);
      });

      //now loop through each nodes to make nodes an array of objects
      // rather than an array of strings
      graph.nodes.forEach(function (d, i) {
        console.log("nodes2", i, d);
        graph.nodes[i] = d.value;
      });

      sankey
        .nodes(graph.nodes)
        .links(graph.links)
        .layout(32);

      // add in the links
      var link = svg3.append("g").selectAll(".link")
        .data(graph.links)
        .enter().append("path")
        .attr("class", "link")
        .attr("d", path)
        .style("stroke-width", function (d) { return Math.max(2, d.dy); })
        .sort(function (a, b) { return b.dy - a.dy; });

      // add the link titles
      link.append("title")
        .text(function (d) {*/
          //return d.source.name.replace(/:.*/, "") + " → " +
          //  d.target.name.replace(/:.*/, "") + "\n" +
          //  "Time " + d.source.name.replace(/.*:/, "") + " → " +
          //  d.target.name.replace(/.*:/, "") + "\n" +
          //  format(d.value) + "\n" +
          //  "Value " + formatMillions(d.source_value) + " → " +
          //  formatMillions(d.target_value) +
          //  " (" + formatFactor(d.target_value
          //    / d.source_value) + ")" + "\n" +
          //  "Plus " + formatNumber((d.target_value - d.source_value) / d.value) + " per claim ";
        /*});

      // add in the nodes
      var node = svg3.append("g").selectAll(".node")
        .data(graph.nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", function (d) {
          return "translate(" + d.x + "," + d.y + ")";
        })
        .call(d3.drag()
          .subject(function (d) { return d; })
          .on("start", function () { this.parentNode.appendChild(this); })
          .on("drag", dragmove));

      // add the rectangles for the nodes
      node.append("rect")
        .attr("height", function (d, i) { return d.dy; })
        .attr("width", sankey.nodeWidth())
        .style("fill", function (d) {*/
        //  return d.color = color(d.name.replace(/:.*/, ""));
        /*})
        .style("stroke", function (d) {
          return d3.rgb(d.color).darker(2);
        })
        .append("title")
        .text(function (d) {
          return d.name + "\n" + format(d.value);
        });

      // add in the title for the nodes
      node.append("text")
        .attr("x", -6)
        .attr("y", function (d) { return d.dy / 2; })
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .attr("transform", null)
        .text(function (d) { return d.name; })
        .filter(function (d) { return d.x < width / 2; })
        .attr("x", 6 + sankey.nodeWidth())
        .attr("text-anchor", "start");

      // the function for moving the nodes
      function dragmove(d) {
        d3.select(this)
          .attr("transform",
            "translate("
            + d.x + ","
            + (d.y = Math.max(
              0, Math.min(height - d.dy, d3.event.y))
            ) + ")");
        sankey.relayout();
        link.attr("d", path);
      }*/
    });

  </script>

</body>

</html>